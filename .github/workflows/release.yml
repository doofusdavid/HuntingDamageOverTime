name: Build and Release Mod

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Download Vintage Story
      run: |
        # Download the latest stable Vintage Story version for Linux
        mkdir -p $HOME/vintagestory
        cd $HOME/vintagestory

        # Try downloading the archive
        if wget https://cdn.vintagestory.at/gamefiles/stable/vs_client_linux-x64_1.21.6.tar.gz; then
          tar -xzf vs_client_linux-x64_1.21.6.tar.gz
        else
          echo "Failed to download from CDN, trying alternative..."
          wget https://github.com/anegostudios/vintagestory/releases/download/v1.21.6/vs_archive_1.21.6.tar.gz
          tar -xzf vs_archive_1.21.6.tar.gz
        fi

        # List contents to debug
        echo "Contents of vintagestory directory:"
        ls -la

        # Set environment variable - the DLLs should be in the current directory or a subdirectory
        echo "VINTAGE_STORY=$HOME/vintagestory" >> $GITHUB_ENV

    - name: Verify Vintage Story DLLs
      run: |
        echo "Checking for required DLLs..."
        find $HOME/vintagestory -name "VintagestoryAPI.dll" -o -name "VintagestoryLib.dll"
        echo "VINTAGE_STORY is set to: $VINTAGE_STORY"

    - name: Build mod with Cake
      run: |
        cd HuntingDamageOverTime/ZZCakeBuild
        dotnet run --configuration Release

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: HuntingDamageOverTime/Releases/*.zip
        body: |
          ## Hunting Damage Over Time v${{ steps.get_version.outputs.VERSION }}

          Adds bleeding damage over time when animals are hit with arrows or spears.

          ### Installation
          1. Download the zip file below
          2. Extract to your Vintage Story `Mods` folder
          3. Restart the server/client

          ### Configuration
          - Damage per second: 0.5
          - Duration: 30 seconds
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
