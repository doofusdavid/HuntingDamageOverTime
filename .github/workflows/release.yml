name: Build and Release Mod

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Download Vintage Story
      run: |
        # Download the latest stable Vintage Story version for Linux
        mkdir -p $HOME/vintagestory
        cd $HOME/vintagestory

        # Download the Linux client
        wget https://cdn.vintagestory.at/gamefiles/stable/vs_client_linux-x64_1.21.6.tar.gz
        tar -xzf vs_client_linux-x64_1.21.6.tar.gz

        # List contents to debug
        echo "Contents of vintagestory directory:"
        ls -laR

        # Find where VintagestoryAPI.dll actually is
        API_DLL=$(find . -name "VintagestoryAPI.dll" -print -quit)
        if [ -n "$API_DLL" ]; then
          VS_PATH=$(dirname "$API_DLL")
          echo "Found VintagestoryAPI.dll at: $VS_PATH"
          echo "VINTAGE_STORY=$HOME/vintagestory/$VS_PATH" >> $GITHUB_ENV
        else
          echo "ERROR: VintagestoryAPI.dll not found!"
          exit 1
        fi

    - name: Verify Vintage Story DLLs
      run: |
        echo "VINTAGE_STORY is set to: $VINTAGE_STORY"
        echo "Contents of VINTAGE_STORY directory:"
        ls -la "$VINTAGE_STORY"
        echo "Checking for required DLLs..."
        ls -la "$VINTAGE_STORY"/*.dll | head -20

    - name: Build mod with Cake
      run: |
        cd HuntingDamageOverTime/ZZCakeBuild
        dotnet run --configuration Release

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: HuntingDamageOverTime/Releases/*.zip
        body: |
          ## Hunting Damage Over Time v${{ steps.get_version.outputs.VERSION }}

          Adds bleeding damage over time when animals are hit with arrows or spears.

          ### Installation
          1. Download the zip file below
          2. Extract to your Vintage Story `Mods` folder
          3. Restart the server/client

          ### Configuration
          - Damage per second: 0.5
          - Duration: 30 seconds
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
